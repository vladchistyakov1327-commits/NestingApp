name: Build NestingApp for Windows

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build and Installer
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Configure CMake
        run: cmake -B build -S NestingApp_v7 -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build Release
        run: cmake --build build --config Release --parallel

      - name: Deploy Qt DLLs
        shell: pwsh
        run: |
          $exe = "build\Release\NestingApp.exe"
          
          # Находим путь к Qt
          $qtDir = $env:Qt6_DIR
          Write-Host "Qt6_DIR: $qtDir" -ForegroundColor Green
          
          # Правильный путь к windeployqt
          $windeployqt = Join-Path $qtDir "..\..\..\bin\windeployqt.exe"
          $windeployqt = (Resolve-Path $windeployqt -ErrorAction SilentlyContinue).Path
          
          if ($windeployqt) {
            Write-Host "Found windeployqt: $windeployqt" -ForegroundColor Green
            & $windeployqt --release --no-compiler-runtime --no-translations $exe
          } else {
            # Альтернативный поиск
            $possiblePaths = @(
              "C:\Qt\6.7.0\msvc2019_64\bin\windeployqt.exe",
              "C:\Qt\6.7.0\msvc2022_64\bin\windeployqt.exe",
              "D:\a\NestingApp\Qt\6.7.0\msvc2019_64\bin\windeployqt.exe"
            )
            
            foreach ($path in $possiblePaths) {
              if (Test-Path $path) {
                Write-Host "Found windeployqt at: $path" -ForegroundColor Green
                & $path --release --no-compiler-runtime --no-translations $exe
                break
              }
            }
          }
          
          # Проверяем результат
          Write-Host "Qt DLLs deployed to build\Release" -ForegroundColor Green
          Get-ChildItem build\Release\*.dll | Select-Object Name

      - name: Download VC Redistributable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "redist" | Out-Null
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "redist\vc_redist.x64.exe" -UseBasicParsing

      - name: Build Installer
        shell: pwsh
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $deployDir = (Resolve-Path "build\Release").Path
          $redistDir = (Resolve-Path "redist").Path
          
          Write-Host "Deploy Dir: $deployDir" -ForegroundColor Green
          Write-Host "Redist Dir: $redistDir" -ForegroundColor Green
          
          # Запускаем компилятор
          Write-Host "Running ISCC..." -ForegroundColor Yellow
          & $iscc "/DAppDir=$deployDir" "/DRedistDir=$redistDir" "NestingApp_v7\installer\NestingApp.iss"
          
          # Ищем созданный файл
          Write-Host "Searching for setup file..." -ForegroundColor Yellow
          $setupFile = Get-ChildItem -Path . -Recurse -Filter "NestingApp_v2_Setup.exe" | Select-Object -First 1
          
          if ($setupFile) {
            Write-Host "✅ Setup file found at: $($setupFile.FullName)" -ForegroundColor Green
            # Копируем в корень
            Copy-Item $setupFile.FullName -Destination "NestingApp_v2_Setup.exe" -Force
            Write-Host "✅ Copied to root folder" -ForegroundColor Green
          } else {
            Write-Host "❌ Setup file not found!" -ForegroundColor Red
            exit 1
          }

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: NestingApp_Setup
          path: NestingApp_v2_Setup.exe
          if-no-files-found: error
          retention-days: 30

      - name: Upload Portable
        uses: actions/upload-artifact@v4
        with:
          name: NestingApp_Portable
          path: build/Release/
          retention-days: 14
