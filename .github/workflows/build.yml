name: Build NestingApp for Windows

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build and Installer
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Configure CMake
        run: cmake -B build -S NestingApp_v7 -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build Release
        run: cmake --build build --config Release --parallel

      - name: Deploy Qt DLLs
        shell: pwsh
        run: |
          $exe = "build\Release\NestingApp.exe"
          
          # Находим путь к Qt
          $qtPath = ""
          if (Test-Path env:Qt6_DIR) {
            $qtPath = "$env:Qt6_DIR"
            Write-Host "Qt6_DIR: $qtPath"
          }
          elseif (Test-Path env:IQTA_QT_DIR) {
            $qtPath = "$env:IQTA_QT_DIR\msvc2019_64"
            Write-Host "IQTA_QT_DIR: $qtPath"
          }
          
          # Ищем windeployqt
          $windeployqt = Get-ChildItem -Path $qtPath -Recurse -Filter "windeployqt.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($windeployqt) {
            Write-Host "Found windeployqt: $($windeployqt.FullName)"
            & $windeployqt.FullName --release --no-compiler-runtime --no-translations $exe
          } else {
            Write-Host "Searching in PATH..."
            $windeployqt = Get-Command windeployqt.exe -ErrorAction SilentlyContinue
            if ($windeployqt) {
              & windeployqt --release --no-compiler-runtime --no-translations $exe
            } else {
              Write-Host "WARNING: windeployqt not found, skipping deployment"
            }
          }
          
          Get-ChildItem build\Release\ | Select-Object Name

      - name: Download VC Redistributable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "redist" | Out-Null
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "redist\vc_redist.x64.exe" -UseBasicParsing

      - name: Build Installer
        shell: pwsh
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $deployDir = (Resolve-Path "build\Release").Path
          $redistDir = (Resolve-Path "redist").Path
          
          Write-Host "Deploy Dir: $deployDir" -ForegroundColor Green
          Write-Host "Redist Dir: $redistDir" -ForegroundColor Green
          
          # Создаем папку dist в корне
          New-Item -ItemType Directory -Force -Path "dist" | Out-Null
          $outDir = (Resolve-Path "dist").Path
          Write-Host "Output Dir: $outDir" -ForegroundColor Green
          
          # Запускаем компилятор
          Write-Host "Running ISCC..." -ForegroundColor Yellow
          & $iscc "/DAppDir=$deployDir" "/DOutputDir=$outDir" "/DRedistDir=$redistDir" "NestingApp_v7\installer\NestingApp.iss"
          
          # Ищем созданный файл
          Write-Host "Searching for setup file..." -ForegroundColor Yellow
          $setupFile = Get-ChildItem -Path . -Recurse -Filter "NestingApp_v2_Setup.exe" | Select-Object -First 1
          
          if ($setupFile) {
            Write-Host "✅ Setup file found at: $($setupFile.FullName)" -ForegroundColor Green
            # Копируем в корневую dist папку если нужно
            if ($setupFile.Directory.Name -ne "dist") {
              Copy-Item $setupFile.FullName -Destination "dist\" -Force
              Write-Host "✅ Copied to dist folder" -ForegroundColor Green
            }
          } else {
            Write-Host "❌ Setup file not found!" -ForegroundColor Red
            exit 1
          }

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: NestingApp_Setup
          path: dist/NestingApp_v2_Setup.exe
          if-no-files-found: error
          retention-days: 30

      - name: Upload Portable
        uses: actions/upload-artifact@v4
        with:
          name: NestingApp_Portable
          path: build/Release/
          retention-days: 14
