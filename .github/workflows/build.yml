name: Build NestingApp for Windows

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build and Installer
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Configure CMake
        run: cmake -B build -S NestingApp_v7 -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build Release
        run: cmake --build build --config Release --parallel

      - name: Deploy Qt DLLs
        shell: pwsh
        run: |
          $exe = "build\Release\NestingApp.exe"
          $qtPath = "$env:Qt6_DIR"
          $windeployqt = "$qtPath\..\..\..\bin\windeployqt.exe"
          Write-Host "Using windeployqt: $windeployqt"
          & $windeployqt --release --no-compiler-runtime --no-translations $exe

      - name: Download VC Redistributable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "redist" | Out-Null
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "redist\vc_redist.x64.exe" -UseBasicParsing

      - name: Build Installer
        shell: pwsh
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $deployDir = (Resolve-Path "build\Release").Path
          $redistDir = (Resolve-Path "redist").Path
          
          Write-Host "Deploy Dir: $deployDir"
          Write-Host "Redist Dir: $redistDir"
          
          # Запускаем компилятор (файл создастся в NestingApp_v7\installer\dist\)
          & $iscc "/DAppDir=$deployDir" "/DRedistDir=$redistDir" "NestingApp_v7\installer\NestingApp.iss"
          
          # Проверяем где создался файл
          Write-Host "Looking for setup file..." -ForegroundColor Yellow
          Get-ChildItem -Path NestingApp_v7\installer -Recurse -Filter "*.exe" | ForEach-Object {
            Write-Host "Found: $($_.FullName)" -ForegroundColor Green
            # Копируем в корень для upload
            Copy-Item $_.FullName -Destination "NestingApp_v2_Setup.exe" -Force
          }

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: NestingApp_Setup
          path: NestingApp_v2_Setup.exe
          if-no-files-found: error
          retention-days: 30

      - name: Upload Portable
        uses: actions/upload-artifact@v4
        with:
          name: NestingApp_Portable
          path: build/Release/
          retention-days: 14
